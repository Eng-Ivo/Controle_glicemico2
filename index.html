<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Meu Controlo de Glicemia</title>
    <!-- Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF para exportar relatórios (NOVOS SCRIPTS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados para garantir que fica bonito no telemóvel e no computador */
        body {
            background-color: #f4f7f4;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        /* Oculta a barra de scroll mas permite fazer scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="text-gray-800">

<!-- Tela de carregamento enquanto conecta ao banco de dados -->
<div id="loading-overlay">
    <div class="flex flex-col items-center gap-2">
        <i data-lucide="loader-2" class="w-8 h-8 text-green-600 animate-spin"></i>
        <p class="text-sm font-semibold text-green-700">Conectando ao banco de dados...</p>
    </div>
</div>

<div class="app-container flex flex-col relative pb-20">
    
    <!-- Cabeçalho -->
    <header class="bg-green-600 text-white p-6 rounded-b-3xl shadow-md z-10">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold tracking-wide">A Minha Glicemia</h1>
            <i data-lucide="activity" class="w-6 h-6"></i>
        </div>
        
        <!-- Cartões de Resumo Diário -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white/20 rounded-xl p-4 backdrop-blur-sm border border-white/30">
                <p class="text-xs text-green-50 mb-1">Média Estimada</p>
                <div class="flex items-end gap-1">
                    <span id="average-glucose" class="text-3xl font-extrabold">--</span>
                    <span class="text-xs font-medium mb-1">mg/dL</span>
                </div>
            </div>
            <div class="bg-white/20 rounded-xl p-4 backdrop-blur-sm border border-white/30">
                <p class="text-xs text-green-50 mb-1">HbA1c Estimada</p>
                <div class="flex items-end gap-1">
                    <span id="estimated-hba1c" class="text-3xl font-extrabold">--</span>
                    <span class="text-xs font-medium mb-1">%</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 -mt-4 z-0">
        
        <!-- Secção do Gráfico -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6 pt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">Evolução</h2>
                <span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-1 rounded-full">Alvo: 70 - 180</span>
            </div>
            <div class="relative h-48 w-full">
                <canvas id="glucoseChart"></canvas>
            </div>
        </section>

        <!-- Formulário de Registo Rápido -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5 text-green-500"></i>
                Novo Registo
            </h2>
            
            <div id="alert-message" class="hidden mb-4 p-3 rounded-lg text-sm text-white bg-red-500">
                Por favor, insira um valor válido.
            </div>

            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wider">Valor (mg/dL)</label>
                    <input type="number" id="glucose-input" placeholder="Ex: 105" 
                           class="w-full text-xl p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wider">Momento</label>
                    <select id="moment-input" 
                            class="w-full text-md p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all appearance-none bg-white">
                        <option value="Jejum">Jejum</option>
                        <option value="Pré-refeição">Pré-refeição</option>
                        <option value="Pós-refeição">Pós-refeição</option>
                        <option value="Ao deitar">Ao deitar</option>
                    </select>
                </div>
            </div>
            
            <button onclick="addEntry()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold text-lg py-3 rounded-xl transition-colors shadow-sm shadow-green-200 flex justify-center items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                Guardar Registo
            </button>
        </section>

        <!-- Histórico (Lista) -->
        <section>
            <h2 class="text-lg font-bold text-gray-700 mb-4 px-1">Histórico Recente</h2>
            <div id="history-list" class="flex flex-col gap-3">
                <p class="text-sm text-gray-400 text-center py-4">Sem registos ainda.</p>
            </div>
        </section>

        <!-- NOVA SECÇÃO: Exportar Relatório -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mt-6 mb-6">
            <h2 class="text-lg font-bold text-gray-700 mb-2 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-green-600"></i>
                Relatório para o Médico
            </h2>
            <p class="text-sm text-gray-500 mb-4">Escolha o mês e gere um documento em PDF com as suas medições.</p>
            
            <div class="flex gap-3">
                <input type="month" id="report-month" 
                       class="flex-1 p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-gray-700 font-medium">
                <button onclick="generatePDF()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold px-4 py-3 rounded-xl transition-colors shadow-sm flex items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Baixar PDF
                </button>
            </div>
        </section>

    </main>

</div>

<script type="module">
    // Importações do Firebase v11
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuração do Firebase disponibilizada pelo ambiente
    let firebaseConfig = {};
    try {
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        }
    } catch (e) { console.error("Erro ao carregar configurações do banco de dados", e); }
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'glicemia-app-ivo';

    let currentUser = null;
    let entries = []; // Agora inicia vazio e será preenchido pelo banco de dados
    let chartInstance = null;

    // Inicializar ícones
    lucide.createIcons();

    // 1. AUTENTICAÇÃO E CONEXÃO INICIAL
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erro na autenticação:", error);
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            // Se autenticado com sucesso, começar a buscar os dados
            setupRealtimeListener();
        }
    });

    // 2. BUSCAR DADOS DO SERVIDOR EM TEMPO REAL
    let unsubscribeSnapshot = null;
    function setupRealtimeListener() {
        if (!currentUser) return;
        
        // Caminho privado e seguro para os dados do usuário
        const entriesRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'glucose_entries');
        
        if (unsubscribeSnapshot) unsubscribeSnapshot();

        unsubscribeSnapshot = onSnapshot(entriesRef, (snapshot) => {
            entries = [];
            snapshot.forEach((doc) => {
                entries.push({ id: doc.id, ...doc.data() });
            });
            
            // Atualizar interface com os dados novos do banco
            renderHistory();
            renderChart();
            updateAverage();

            // Esconder tela de carregamento após a primeira busca
            document.getElementById('loading-overlay').style.display = 'none';

        }, (error) => {
            console.error("Erro ao buscar dados do servidor:", error);
            document.getElementById('loading-overlay').style.display = 'none';
        });
    }

    // Função para calcular a HbA1c estimada baseada na média (fórmula ADAG)
    function calculateHbA1c(avgGlucose) {
        return ((avgGlucose + 46.7) / 28.7).toFixed(1);
    }

    // Funções auxiliares para classificar a glicemia
    function getStatus(value) {
        if (value < 70) return { label: 'Hipo', color: '#3b82f6', bgClass: 'bg-blue-100', textClass: 'text-blue-700' }; // Azul
        if (value > 180) return { label: 'Hiper', color: '#ef4444', bgClass: 'bg-red-100', textClass: 'text-red-700' }; // Vermelho
        return { label: 'Normal', color: '#10b981', bgClass: 'bg-green-100', textClass: 'text-green-700' }; // Verde
    }

    // Atualizar a lista na interface
    function renderHistory() {
        const listContainer = document.getElementById('history-list');
        listContainer.innerHTML = '';

        if (entries.length === 0) {
            listContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Nenhum registo encontrado.</p>';
            return;
        }

        // Ordenar do mais recente para o mais antigo para a lista
        const sortedEntries = [...entries].sort((a, b) => b.timestamp - a.timestamp);

        // Mostrar apenas os 10 últimos na lista principal para não ficar gigante
        const recentEntries = sortedEntries.slice(0, 10);

        recentEntries.forEach(entry => {
            const date = new Date(entry.timestamp);
            const timeString = date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString('pt-PT', { day: '2-digit', month: 'short' });
            const status = getStatus(entry.value);

            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center transition-all hover:shadow-md';
            el.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full ${status.bgClass} flex items-center justify-center border-2 border-white shadow-inner">
                        <span class="font-bold ${status.textClass}">${entry.value}</span>
                    </div>
                    <div>
                        <p class="font-bold text-gray-800">${entry.moment}</p>
                        <p class="text-xs text-gray-500 flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${dateString}, ${timeString}
                        </p>
                    </div>
                </div>
                <div class="px-3 py-1 rounded-lg text-xs font-bold ${status.bgClass} ${status.textClass}">
                    ${status.label}
                </div>
            `;
            listContainer.appendChild(el);
        });
        
        lucide.createIcons();
    }

    // Atualizar o gráfico
    function renderChart() {
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        
        // Ordenar do mais antigo para o mais recente para o gráfico
        const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);

        // Limitar gráfico aos últimos 15 registros
        const chartEntries = sortedEntries.slice(-15);

        const labels = chartEntries.map(e => {
            const d = new Date(e.timestamp);
            return d.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' }) + ' ' + 
                   d.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
        });
        
        const dataValues = chartEntries.map(e => e.value);
        const pointColors = dataValues.map(val => getStatus(val).color);

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Glicemia (mg/dL)',
                    data: dataValues,
                    borderColor: '#a7f3d0', 
                    borderWidth: 3,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' mg/dL';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        suggestedMin: 50,
                        suggestedMax: 250,
                        grid: { color: '#f3f4f6', drawBorder: false },
                        ticks: { font: { size: 10, family: 'system-ui' }, color: '#9ca3af' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            display: false // Oculta os rótulos do eixo X para manter limpo, mas eles aparecem no tooltip
                        }
                    }
                }
            },
            plugins: [{
                id: 'targetZone',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { top, right, bottom, left, width, height }, scales: { y } } = chart;
                    ctx.save();
                    
                    const y70 = y.getPixelForValue(70);
                    const y180 = y.getPixelForValue(180);
                    
                    if (y70 && y180) {
                        ctx.fillStyle = 'rgba(16, 185, 129, 0.05)';
                        ctx.fillRect(left, y180, width, y70 - y180);
                        
                        ctx.beginPath();
                        ctx.setLineDash([5, 5]);
                        ctx.moveTo(left, y180);
                        ctx.lineTo(right, y180);
                        ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(left, y70);
                        ctx.lineTo(right, y70);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            }]
        });
    }

    function updateAverage() {
        if (entries.length === 0) {
            document.getElementById('average-glucose').innerText = '--';
            document.getElementById('estimated-hba1c').innerText = '--';
            return;
        }
        const sum = entries.reduce((acc, curr) => acc + curr.value, 0);
        const avg = Math.round(sum / entries.length);
        document.getElementById('average-glucose').innerText = avg;
        document.getElementById('estimated-hba1c').innerText = calculateHbA1c(avg);
    }

    // 3. SALVAR NOVO REGISTO NO BANCO DE DADOS
    window.addEntry = async function() {
        const valueInput = document.getElementById('glucose-input');
        const momentInput = document.getElementById('moment-input');
        const alertMsg = document.getElementById('alert-message');
        
        const value = parseInt(valueInput.value);
        const moment = momentInput.value;

        if (isNaN(value) || value <= 0) {
            alertMsg.classList.remove('hidden');
            setTimeout(() => alertMsg.classList.add('hidden'), 3000);
            return;
        }

        if (!currentUser) {
            alert("Aguarde a conexão com o banco de dados antes de salvar.");
            return;
        }

        const timestamp = Date.now();
        const entryData = {
            value: value,
            moment: moment,
            timestamp: timestamp
        };

        // Mostrar tela de carregamento rápido
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Salvando...';
        lucide.createIcons();
        btn.disabled = true;

        try {
            // Salvar no Firestore
            const entryRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'glucose_entries'), timestamp.toString());
            await setDoc(entryRef, entryData);
            
            // Limpar input
            valueInput.value = '';
            valueInput.blur();
        } catch (error) {
            console.error("Erro ao salvar:", error);
            alert("Ocorreu um erro ao salvar os dados no servidor.");
        } finally {
            // Restaurar botão
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // Definir o mês atual no campo de relatório por padrão
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    document.getElementById('report-month').value = `${year}-${month}`;

    // 4. GERAR PDF COM OS DADOS DO BANCO
    window.generatePDF = function() {
        const monthInput = document.getElementById('report-month').value;
        if (!monthInput) {
            alert("Por favor, selecione um mês válido.");
            return;
        }

        const [year, month] = monthInput.split('-');
        
        // Filtrar registos (já vieram do banco de dados) do mês selecionado
        const filteredEntries = entries.filter(entry => {
            const entryDate = new Date(entry.timestamp);
            return entryDate.getFullYear() == year && (entryDate.getMonth() + 1) == parseInt(month);
        });

        if (filteredEntries.length === 0) {
            alert("Não existem registos de glicemia no mês selecionado.");
            return;
        }

        // Ordenar por data (do mais antigo para o mais recente)
        filteredEntries.sort((a, b) => a.timestamp - b.timestamp);

        // Inicializar o jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // --- DADOS DO PACIENTE E CÁLCULO DE IDADE ---
        const patientName = "Ivo José de Oliveira";
        const birthDateStr = "16/05/1969";
        
        const [bDay, bMonth, bYear] = birthDateStr.split('/');
        const birthDateObj = new Date(bYear, bMonth - 1, bDay);
        const today = new Date();
        
        let age = today.getFullYear() - birthDateObj.getFullYear();
        const m = today.getMonth() - birthDateObj.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDateObj.getDate())) {
            age--;
        }

        // Cabeçalho do Documento
        doc.setFontSize(20);
        doc.setTextColor(22, 163, 74); 
        doc.text(`Relatório de Glicemia`, 14, 22);
        
        // Imprimir Dados do Paciente
        doc.setFontSize(12);
        doc.setTextColor(80, 80, 80);
        doc.text(`Paciente: ${patientName}`, 14, 32);
        doc.text(`Nascimento: ${birthDateStr} (${age} anos)`, 14, 38);
        
        doc.setFontSize(11);
        doc.setTextColor(120, 120, 120);
        doc.text(`Período do Relatório: ${month}/${year}`, 14, 48);

        // Calcular Estatísticas
        const sum = filteredEntries.reduce((acc, curr) => acc + curr.value, 0);
        const avg = Math.round(sum / filteredEntries.length);
        const max = Math.max(...filteredEntries.map(e => e.value));
        const min = Math.min(...filteredEntries.map(e => e.value));
        const hba1c = calculateHbA1c(avg);

        doc.setFontSize(11);
        doc.setTextColor(50, 50, 50);
        doc.text(`Resumo:  Média: ${avg} mg/dL   |   HbA1c Est.: ${hba1c}%   |   Mín/Máx: ${min}/${max} mg/dL`, 14, 58);

        const tableData = filteredEntries.map(entry => {
            const date = new Date(entry.timestamp);
            const dateStr = date.toLocaleDateString('pt-PT');
            const timeStr = date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
            const status = getStatus(entry.value).label;
            return [dateStr, timeStr, `${entry.value} mg/dL`, entry.moment, status];
        });

        doc.autoTable({
            startY: 64,
            head: [['Data', 'Hora', 'Valor', 'Momento', 'Estado']],
            body: tableData,
            headStyles: { fillColor: [22, 163, 74] }, 
            alternateRowStyles: { fillColor: [240, 253, 244] }, 
            styles: { fontSize: 10, cellPadding: 3 },
            didParseCell: function(data) {
                if (data.section === 'body' && data.column.index === 4) {
                    if (data.cell.raw === 'Hiper') data.cell.styles.textColor = [220, 38, 38]; 
                    if (data.cell.raw === 'Hipo') data.cell.styles.textColor = [37, 99, 235];  
                    if (data.cell.raw === 'Normal') data.cell.styles.textColor = [22, 163, 74]; 
                }
            }
        });

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text(`Gerado via Meu Controlo de Glicemia - Página ${i} de ${pageCount}`, 14, doc.internal.pageSize.height - 10);
        }

        doc.save(`Glicemia_Ivo_Oliveira_${year}_${month}.pdf`);
    }
</script>
</body>
</html>
